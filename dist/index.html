<!DOCTYPE html>
<html lang="en">

<script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const f of i.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&a(f)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();var be;(function(e){e[e.trace=10]="trace",e[e.debug=20]="debug",e[e.info=30]="info",e[e.warn=40]="warn",e[e.error=50]="error",e[e.fatal=60]="fatal",e[e.silent=Number.MAX_SAFE_INTEGER]="silent"})(be||(be={}));function Ge(){return Object.freeze({fatal:(e,t)=>console.error(t,e),error:(e,t)=>console.error(t,e),warn:(e,t)=>console.warn(t,e),info:(e,t)=>console.info(t,e),debug:(e,t)=>console.debug(t,e),trace(){},silent(){},redact(){}})}let x=Ge();const qe={},Xe=e=>{let t=new Array;return{add:n=>{if(e===0)return[];t.length<e?t.splice(e,0,n):t=[...t.slice(1),n]},entries:()=>t.slice(0),forEach:n=>{t.forEach(n)}}},Qe="Anonymous",Ye="AnonymousSignal";function U(e){return e.name||Qe}function y(e={}){const{allowEmittingWithoutObserver:t=!1,variant:n="generic",bufferSize:a=2,name:o=Ye}=e,i=new Set,f=new WeakMap,h=new WeakSet,g=n!=="generic"?Xe(n==="behavior"?1:a):void 0;function l(c,s){try{const w=f.get(c);x.trace({signal:o,subject:s,observer:c,context:w},`Emitting a subject to observer ${U(c)}`),c.call(w,s),h.has(c)&&b(c)}catch(w){throw x.error({signal:o,error:w,observer:c,subject:s},`emit with error for observer ${U(c)}`),w instanceof RangeError?new RangeError(`RangeError: Possible recursive call when calling ${U(c)} for ${o}`):w}}const u=(c,s)=>{if(i.has(c)){const w=`Observer ${U(c)} has already been added!`;throw x.error({signal:o,observer:c},w),new Error(`DuplicatedObserver: ${w}`)}return x.trace({signal:o,observer:c},`Adding ${U(c)} to ${o}`),i.add(c),s&&f.set(c,s),g?.forEach(w=>{l(c,w)}),()=>b(c)},p=(c,s)=>{if(h.has(c)){const w=`${U(c)} has already been added once to ${o}!`;throw x.error({signal:o,observer:c},w),new Error(`NoOnceAgain: ${w}`)}return h.add(c),u(c,s)},b=c=>{if(!i.delete(c))throw x.error({signal:o,observer:c},`Unable to remove observer ${U(c)}`),new Error(`UnableToRemove: ${U(c)}`);h.delete(c),f.delete(c),x.trace({signal:o,observer:c},`Removed ${U(c)} from ${o}`)},P=()=>i.size;function m(c){if(g)g.add(c);else if(!i.size&&!t){const{stack:s}=qe.debug?new Error:{stack:void 0};x.warn({signal:o,subject:c,stack:s},`Emitting ${o} without any observer! This may be a mistake.`)}i.forEach(s=>{l(s,c)})}return{name:o,get size(){return P()},add:u,addOnce:p,remove:b,emit:m}}var Re;(function(e){e[e.trace=10]="trace",e[e.debug=20]="debug",e[e.info=30]="info",e[e.warn=40]="warn",e[e.error=50]="error",e[e.fatal=60]="fatal",e[e.silent=Number.MAX_SAFE_INTEGER]="silent"})(Re||(Re={}));function Ze(){return Object.freeze({fatal:(e,t)=>console.error(t,e),error:(e,t)=>console.error(t,e),warn:(e,t)=>console.warn(t,e),info:(e,t)=>console.info(t,e),debug:(e,t)=>console.debug(t,e),trace(){},silent(){},redact(){}})}let j=Ze();function Ke(e){return!!(e&&typeof e=="object"&&"chanId"in e&&"event"in e)}function et(e){return!!(e&&typeof e=="object"&&"chanId"in e&&"replyTo"in e)}let q;const tt=new Uint8Array(16);function nt(){if(!q&&(q=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!q))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return q(tt)}const C=[];for(let e=0;e<256;++e)C.push((e+256).toString(16).slice(1));function rt(e,t=0){return C[e[t+0]]+C[e[t+1]]+C[e[t+2]]+C[e[t+3]]+"-"+C[e[t+4]]+C[e[t+5]]+"-"+C[e[t+6]]+C[e[t+7]]+"-"+C[e[t+8]]+C[e[t+9]]+"-"+C[e[t+10]]+C[e[t+11]]+C[e[t+12]]+C[e[t+13]]+C[e[t+14]]+C[e[t+15]]}const ot=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Pe={randomUUID:ot};function at(e,t,n){if(Pe.randomUUID&&!e)return Pe.randomUUID();e=e||{};const a=e.random||(e.rng||nt)();return a[6]=a[6]&15|64,a[8]=a[8]&63|128,rt(a)}const it="400px",st="200px";function _e(e){return`${e?`${e}-`:""}${at()}`}function ct(){const e=new Map,t=new Set;return window.onbeforeunload=()=>{t.forEach(f=>clearInterval(f)),t.clear()},{add:(f,h)=>{if(e.has(f)){j.warn(`A popup with with ID:'${f}' has already been registered`);return}e.set(f,{popup:null,shouldOpen:h})},remove:f=>{e.delete(f)},open:(f,h,g)=>{e.has(f)||e.set(f,{popup:null});const l=e.get(f);if(l?.popup&&!l.popup.closed){j.warn(`Popup with ID:'${f}' is currently opened`);return}if(e.get(f)?.shouldOpen&&!e.get(f)?.shouldOpen?.(g??{}))return;const u=window.open(...h);if(l&&(l.popup=u),u){const p=window.setInterval(()=>{if(u.closed){const b=e.get(f);b&&(b.popup=null),clearInterval(p),t.delete(p)}},500);t.add(p)}},get:f=>e.get(f)?.popup}}function ut(){const e=new Map;return{add:({id:o,url:i,type:f,...h})=>{if(e.has(o)){j.warn(`An iframe with with ID:'${o}' has already been registered`);return}const{headerTitle:g,initPosition:l}={...h},u=document.createElement("iframe");u.src=i;const p=l??{width:it,height:st};return e.set(o,{element:u,type:f,headerTitle:g,initPosition:p}),u},remove:o=>{e.delete(o)},open,get:o=>e.get(o)}}class lt{constructor(t,n){this.target=t,this.chanId=n,this.pendingCalls=new Map,this.eventListeners=new Set,this.onMessage=a=>{if(a.data.chanId!==this.chanId)return;const o=a.data;if(j.debug({evt:a},`Message received for channel ${this.chanId}`),et(o)){const[i,f]=this.pendingCalls.get(o.replyTo)??[];if(!i){j.debug({evt:a},"Resolve fn doesnt exist");return}this.pendingCalls.delete(o.replyTo),i(o.payload)}Ke(o)&&this.eventListeners.forEach(i=>{i(o)})},globalThis.addEventListener("message",this.onMessage)}addEventListener(t){this.eventListeners.add(t)}removeEventListener(t){this.eventListeners.delete(t)}emitEvent(t){this.target.postMessage({chanId:this.chanId,...t},"*")}callRPC(t,n,a){const o=_e();return j.debug({payload:n,id:o},`'${t}' called for channel ${this.chanId}`),new Promise((i,f)=>{this.pendingCalls.set(o,[i,f]),this.target.postMessage({rpc:t,payload:n,id:o,chanId:this.chanId},"*",a)})}replyRPC(t){this.emitEvent(t)}sendEvent(t){this.emitEvent(t)}unregister(){globalThis.removeEventListener("message",this.onMessage)}get targetWindow(){return this.target}}var Ee;(function(e){e.audio="audio",e.video="video",e.api="api"})(Ee||(Ee={}));async function dt(e){window.plugin={popupManager:ct(),iframeManager:ut()};const t=new lt(window.parent,_e(e.id)),n=await t.callRPC("syn",e);if(!n.ack)throw new Error(`Can't register a plugin. ${JSON.stringify(n)}`);const a=new Map,o=new Map,i=new Map,f=new Map,h=y({allowEmittingWithoutObserver:!0}),g=y({allowEmittingWithoutObserver:!0}),l=y({allowEmittingWithoutObserver:!0}),u=y({allowEmittingWithoutObserver:!0}),p=y({allowEmittingWithoutObserver:!0}),b=y({allowEmittingWithoutObserver:!0}),P=y({allowEmittingWithoutObserver:!0}),m=y({allowEmittingWithoutObserver:!0}),c=y({allowEmittingWithoutObserver:!0}),s=y({allowEmittingWithoutObserver:!0}),w=y({allowEmittingWithoutObserver:!0}),A=y({allowEmittingWithoutObserver:!0}),R=y({allowEmittingWithoutObserver:!0}),z=y({allowEmittingWithoutObserver:!0}),$=y({allowEmittingWithoutObserver:!0}),pe=y({allowEmittingWithoutObserver:!0}),fe=y({allowEmittingWithoutObserver:!0}),ge=y({allowEmittingWithoutObserver:!0}),he=y({allowEmittingWithoutObserver:!0}),me=y({allowEmittingWithoutObserver:!0}),we=y({allowEmittingWithoutObserver:!0}),ye=y({allowEmittingWithoutObserver:!0});t.addEventListener(r=>{switch(r.event){case"ui:button:click":a.get(r.payload.buttonId)?.onClick.emit(r.payload.input);break;case"ui:form:input":i.get(r.payload.modalId)?.onInput.emit(r.payload.input);break;case"ui:prompt:input":f.get(r.payload.modalId)?.onInput.emit(r.payload.input);break;case"participant:disconnected":o.get(r.payload.participantUuid)?.onDisconnect.emit(),o.delete(r.payload.participantUuid);break;case"event:conferenceStatus":g.emit(r.payload);break;case"event:connected":l.emit(r.payload);break;case"event:disconnected":u.emit(r.payload);break;case"event:userInitiatedDisconnect":p.emit(r.payload);break;case"event:me":b.emit(r.payload);break;case"event:message":w.emit(r.payload);break;case"event:directMessage":A.emit(r.payload);break;case"event:applicationMessage":R.emit(r.payload);break;case"event:transfer":z.emit(r.payload);break;case"event:cancelTransfer":$.emit(r.payload);break;case"event:stage":pe.emit(r.payload);break;case"event:participants":P.emit(r.payload);break;case"event:participantLeft":c.emit(r.payload),o.get(r.payload.participant.uuid)?.onDisconnect.emit(),o.delete(r.payload.participant.uuid);break;case"event:participantJoined":m.emit(r.payload);break;case"event:raiseHand":s.emit(r.payload);break;case"event:presentationConnectionStateChange":fe.emit(r.payload);break;case"event:layoutUpdate":ge.emit(r.payload);break;case"event:conference:authenticated":h.emit(r.payload);break;case"event:breakoutBegin":he.emit(r.payload);break;case"event:breakoutEnd":me.emit(r.payload);break;case"event:breakoutRefer":we.emit(r.payload);break;case"event:languageSelect":ye.emit(r.payload);break}});const B=async(r,d)=>{const k=await t.callRPC("ui:removeElement",{id:r});if(k.status==="failed")return Promise.reject({reason:k.reason});d&&d()};return{ui:{addButton:async r=>{const d=await t.callRPC("ui:button:add",r);if(d.status==="failed")return Promise.reject({reason:d.reason});const k={onClick:y({allowEmittingWithoutObserver:!0}),update:async T=>{const I=await t.callRPC("ui:button:update",{...T,targetId:d.id});return I.status==="failed"?Promise.reject({reason:I.reason}):I.data},remove:()=>B(d.id,()=>a.delete(d.id))};return a.set(d.id,k),k},addForm:async r=>{const d=await t.callRPC("ui:form:open",r);if(d.status==="failed")return Promise.reject({reason:d.reason});const k={onInput:y(),remove:()=>B(d.id,()=>i.delete(d.id))};return i.set(d.id,k),k},showForm:async r=>{const d=await t.callRPC("ui:form:open",r);return d.status==="failed"?Promise.reject({reason:d.reason}):new Promise(k=>{const T=I=>{I.event==="ui:form:input"&&I.payload.modalId===d.id&&(k(I.payload.input),B(d.id),t.removeEventListener(T))};t.addEventListener(T)})},addPrompt:async r=>{const d=await t.callRPC("ui:prompt:open",r);if(d.status==="failed")return Promise.reject({reason:d.reason});const k={onInput:y(),remove:()=>B(d.id,()=>f.delete(d.id))};return f.set(d.id,k),k},showPrompt:async r=>{const d=await t.callRPC("ui:prompt:open",r);return d.status==="failed"?Promise.reject({reason:d.reason}):new Promise(k=>{const T=I=>{I.event==="ui:prompt:input"&&I.payload.modalId===d.id&&(k(I.payload.input),B(d.id),t.removeEventListener(T))};t.addEventListener(T)})},showToast:async r=>{const d=await t.callRPC("ui:toast:show",r);if(d.status==="failed")return Promise.reject({reason:d.reason})},togglePlugin:async r=>{const d=await t.callRPC("ui:plugin:toggle",r);if(d.status==="failed")return Promise.reject({reason:d.reason})}},conference:{dialOut:async r=>{let d;const k=new Map;let T=()=>{};const I=new Promise(ze=>{T=m.add(({participant:G})=>{d?d.data.result.includes(G.uuid)&&ze(G):k.set(G.uuid,G)})});d=await t.callRPC("conference:dialOut",r);const V=d?.data.result[0];if(!V)throw Error("Could not dial out to specified uri");const He=k.get(V)??await I;T();const ve={...He,onDisconnect:y({allowEmittingWithoutObserver:!0}),disconnect:async()=>(o.delete(V),t.callRPC("participant:disconnect",{participantUuid:V}))};return o.set(V,ve),ve},sendMessage:async r=>await t.callRPC("conference:sendMessage",r),sendApplicationMessage:async r=>await t.callRPC("conference:sendApplicationMessage",r),lock:async r=>await t.callRPC("conference:lock",r),muteAllGuests:async r=>await t.callRPC("conference:muteAllGuests",r),setBandwidth:async r=>await t.callRPC("conference:setBandwidth",r),setLayout:async r=>await t.callRPC("conference:setLayout",r),disconnectAll:async r=>await t.callRPC("conference:disconnectAll",r),requestParticipants:async r=>await t.callRPC("conference:requestParticipants",r),sendRequest:async r=>await t.callRPC("conference:sendRequest",r),transfer:async r=>await t.callRPC("participant:transfer",r),mute:async r=>await t.callRPC("participant:mute",r),muteVideo:async r=>await t.callRPC("participant:muteVideo",r),spotlight:async r=>await t.callRPC("participant:spotlight",r),admit:async r=>await t.callRPC("participant:admit",r),raiseHand:async r=>await t.callRPC("participant:raiseHand",r),setRole:async r=>await t.callRPC("participant:setRole",r),setTextOverlay:async r=>await t.callRPC("participant:setTextOverlay",r),sendDTMF:async r=>await t.callRPC("participant:sendDTMF",r),disconnect:async r=>{const d=r.participantUuid;return o.delete(d),await t.callRPC("participant:disconnect",{participantUuid:d})},breakout:async r=>await t.callRPC("conference:breakout",r),joinBreakoutRoom:async r=>await t.callRPC("conference:joinBreakoutRoom",r),closeBreakouts:async()=>await t.callRPC("conference:closeBreakouts",{}),closeBreakoutRoom:async r=>await t.callRPC("conference:closeBreakoutRoom",r),emptyBreakouts:async()=>await t.callRPC("conference:emptyBreakouts",{}),breakoutMoveParticipants:async r=>await t.callRPC("conference:breakoutMoveParticipants",r),getCurrentRoomId:async()=>await t.callRPC("conference:currentRoomId",void 0)},events:{authenticatedWithConference:h,conferenceStatus:g,connected:l,disconnected:u,userInitiatedDisconnect:p,me:b,message:w,directMessage:A,applicationMessage:R,transfer:z,cancelTransfer:$,stage:pe,participants:P,participantJoined:m,participantLeft:c,raiseHand:s,presentationConnectionStateChange:fe,layoutUpdate:ge,breakoutBegin:he,breakoutEnd:me,breakoutRefer:we,languageSelect:ye}}}function pt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var te={exports:{}},ke;function ft(){return ke||(ke=1,function(e){var t=Object.prototype.hasOwnProperty,n="~";function a(){}Object.create&&(a.prototype=Object.create(null),new a().__proto__||(n=!1));function o(g,l,u){this.fn=g,this.context=l,this.once=u||!1}function i(g,l,u,p,b){if(typeof u!="function")throw new TypeError("The listener must be a function");var P=new o(u,p||g,b),m=n?n+l:l;return g._events[m]?g._events[m].fn?g._events[m]=[g._events[m],P]:g._events[m].push(P):(g._events[m]=P,g._eventsCount++),g}function f(g,l){--g._eventsCount===0?g._events=new a:delete g._events[l]}function h(){this._events=new a,this._eventsCount=0}h.prototype.eventNames=function(){var l=[],u,p;if(this._eventsCount===0)return l;for(p in u=this._events)t.call(u,p)&&l.push(n?p.slice(1):p);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},h.prototype.listeners=function(l){var u=n?n+l:l,p=this._events[u];if(!p)return[];if(p.fn)return[p.fn];for(var b=0,P=p.length,m=new Array(P);b<P;b++)m[b]=p[b].fn;return m},h.prototype.listenerCount=function(l){var u=n?n+l:l,p=this._events[u];return p?p.fn?1:p.length:0},h.prototype.emit=function(l,u,p,b,P,m){var c=n?n+l:l;if(!this._events[c])return!1;var s=this._events[c],w=arguments.length,A,R;if(s.fn){switch(s.once&&this.removeListener(l,s.fn,void 0,!0),w){case 1:return s.fn.call(s.context),!0;case 2:return s.fn.call(s.context,u),!0;case 3:return s.fn.call(s.context,u,p),!0;case 4:return s.fn.call(s.context,u,p,b),!0;case 5:return s.fn.call(s.context,u,p,b,P),!0;case 6:return s.fn.call(s.context,u,p,b,P,m),!0}for(R=1,A=new Array(w-1);R<w;R++)A[R-1]=arguments[R];s.fn.apply(s.context,A)}else{var z=s.length,$;for(R=0;R<z;R++)switch(s[R].once&&this.removeListener(l,s[R].fn,void 0,!0),w){case 1:s[R].fn.call(s[R].context);break;case 2:s[R].fn.call(s[R].context,u);break;case 3:s[R].fn.call(s[R].context,u,p);break;case 4:s[R].fn.call(s[R].context,u,p,b);break;default:if(!A)for($=1,A=new Array(w-1);$<w;$++)A[$-1]=arguments[$];s[R].fn.apply(s[R].context,A)}}return!0},h.prototype.on=function(l,u,p){return i(this,l,u,p,!1)},h.prototype.once=function(l,u,p){return i(this,l,u,p,!0)},h.prototype.removeListener=function(l,u,p,b){var P=n?n+l:l;if(!this._events[P])return this;if(!u)return f(this,P),this;var m=this._events[P];if(m.fn)m.fn===u&&(!b||m.once)&&(!p||m.context===p)&&f(this,P);else{for(var c=0,s=[],w=m.length;c<w;c++)(m[c].fn!==u||b&&!m[c].once||p&&m[c].context!==p)&&s.push(m[c]);s.length?this._events[P]=s.length===1?s[0]:s:f(this,P)}return this},h.prototype.removeAllListeners=function(l){var u;return l?(u=n?n+l:l,this._events[u]&&f(this,u)):(this._events=new a,this._eventsCount=0),this},h.prototype.off=h.prototype.removeListener,h.prototype.addListener=h.prototype.on,h.prefixed=n,h.EventEmitter=h,e.exports=h}(te)),te.exports}var gt=ft();const Ae=pt(gt);let E;const ht=e=>{E=e};let Y={conferenceAlias:"",conferenceName:void 0};const mt=(e,t)=>{Y={conferenceAlias:e,conferenceName:t}},Ce=async e=>{await E.conference.setLayout({transforms:{recording_indicator:e}})},wt=async e=>{try{await E.conference.setRole({role:"chair",participantUuid:e}),await E.conference.setRole({role:"guest",participantUuid:e})}catch{}},yt=await fetch("./config.json"),v=await yt.json(),Oe="pexip-vbrick";var N=(e=>(e.User=`${Oe}:user`,e.Recording=`${Oe}:recording`,e))(N||{});function Te(e){try{const t=globalThis.localStorage.getItem(e);if(t!=null)return JSON.parse(t)}catch{}return null}function ae(e,t){try{t==null?globalThis.localStorage.removeItem(e):globalThis.localStorage.setItem(e,JSON.stringify(t))}catch{}}let O=Te(N.User);const ie=e=>{O=e,ae(N.User,O)};let re="";const Ue=20,Me=1800;let J=0;const vt=async()=>{const e="/api/v2/oauth2/authorize",t=new URL(e,v.vbrick.url);return t.searchParams.set("client_id",v.vbrick.client_id),t.searchParams.set("code_challenge",await Ot()),t.searchParams.set("response_type","code"),t.searchParams.set("redirect_uri",v.vbrick.redirect_uri),t.toString()},bt=async e=>{const t="/api/v2/oauth2/token",n=new URL(t,v.vbrick.url),a={code:e.replace(/ /g,"+"),grant_type:"authorization_code",client_id:v.vbrick.client_id,redirect_uri:v.vbrick.redirect_uri,code_verifier:re},i=await(await fetch(n,{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}})).json();i.expiration=new Date(Date.now()+i.expires_in*1e3),ie(i),J===0&&We(O?.expires_in??Me-Ue),K.emit("login")},Rt=()=>O?.access_token??"",Pt=()=>O,Z=()=>O!=null&&O.access_token!=="",se=()=>({authorization:`vbrick ${O?.access_token}`}),$e=async()=>{if(O==null||!Z())throw new Error("Cannot recover the user info from the localStorage");const e="/api/v2/user/extend-session",t=new URL(e,v.vbrick.url),n=await fetch(t,{method:"POST",headers:se()}),{expiration:a}=await n.json(),o=new Date(a).getTime()-Date.now();O.expires_in=isNaN(o)?Me:Math.floor(o/1e3),ie(O),J===0&&We(O.expires_in-Ue),K.emit("refreshed_token")},Et=async()=>{const e="/api/v2/user/session",t=new URL(e,v.vbrick.url);return Z()?(await fetch(t,{headers:se()}).catch(a=>{console.error(a)}))?.status===200:!1},kt=async()=>{const e="/api/v2/user/logoff",t=new URL(e,v.vbrick.url);O!=null&&Z()&&await fetch(t,{method:"POST",body:JSON.stringify({userId:O.userId}),headers:{...se(),"Content-Type":"application/json"}}).catch(n=>{console.warn(n)}),xe(),Ct(),K.emit("logout")},xe=()=>{ie(null)},We=e=>{J=setInterval(()=>{$e().catch(t=>{console.error(t)})},e*1e3)},Ct=()=>{clearInterval(J),J=0},K=new Ae,S={getAuthUrl:vt,createAccessToken:bt,getAccessToken:Rt,getUser:Pt,isAuthenticated:Z,refreshAccessToken:$e,isSessionValid:Et,logout:kt,cleanSession:xe,emitter:K},Ot=async()=>(re=It(48),await St(re)),It=e=>{const t=crypto.getRandomValues(new Uint8Array(e/2));return Array.from(t).map(n=>n.toString(16).padStart(2,"0")).join("")},St=async e=>{const t=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",t),a=String.fromCharCode(...new Uint8Array(n));return btoa(a).replace(/\//g,"_").replace(/\+/g,"-").replace(/=+$/,"")},_t=e=>{const{data:{search:t}}=e;if(t!=null&&t!==""){const n=new URLSearchParams(t).get("code");n!=null&&(console.log("code",n),S.createAccessToken(n).catch(console.error))}};window.addEventListener("message",_t);async function F(e,t,n){const{timeoutSeconds:a=0}=n??{},o=At(n,t);try{const i=a>0?await ce(fetch(e,o),a):await fetch(e,o);return i.status!==200?{success:!1,error:`${i.status} ${i.statusText}`}:{success:!0,data:await i.json().catch(()=>{})}}catch(i){return{success:!1,error:i?.toString?.()??"Request Failed"}}}function At(e,t){const n=new Headers(e?.headers),a=S.getAccessToken();a!==""&&n.set("authorization",`Vbrick ${a}`);const o={...e,headers:n};return t==null||(/put|post|patch/i.test(o.method??"")?(n.set("content-type","application/json"),o.body=JSON.stringify(t)):Object.entries(t).forEach(([i,f])=>{n.set(i,f)})),o}async function ce(e,t){let n=-1;return await Promise.race([e,new Promise((a,o)=>{n=setTimeout(()=>{o(new DOMException("Timeout","TimeoutError"))},t*1e3)})]).finally(()=>{clearTimeout(n)})}let je=[];const Tt=e=>{je=e},De=e=>je.find(e),Ut=({serviceType:e},t=!1)=>t?e==="connecting"?"ConnectingFailed":"RecordingFinished":e==="connecting"?"WaitingForStream":"Recording",Mt=async(e=15)=>{const t=Promise.all([new Promise(n=>E.events.participants.addOnce(()=>{n()})),new Promise(n=>E.events.authenticatedWithConference.addOnce(()=>{n()}))]);await ce(t,e)};let _=Te(N.Recording);const Ne=(e=null)=>{_=e,ae(N.Recording,_)},L=()=>_,Fe=()=>{_=null,ae(N.Recording,null)},X=e=>{_!=null&&Ne(Object.assign(_,e))},$t=["Recording","Connecting","WaitingForStream","RecordingStream","StartRecording","RecordingInitializing","StopRecording"],Le=()=>{const e=v.recording_type==="rtmp"?_?.rtmpStreamKey:_?.videoId;return e!=null&&e!==""},ue=()=>Le()&&typeof _?.status=="string"&&$t.includes(_.status),Q=()=>_?.status==="Connecting"||_?.status==="WaitingForStream",xt=()=>!Q()&&ue();async function Wt(e,t=60){const n="/recapi/v0/rtmp/start-recording",a=new URL(n,v.recorder.url),o={title:e,route:v.recorder.route,...Y},i=await F(a,o,{method:"POST",timeoutSeconds:t});return i.success&&jt(i.data.rtmpUrl),i}async function jt(e){return await E.conference.dialOut({destination:e,protocol:v.recorder.legacy_dialout_api===!0?"rtmp":"auto",role:"GUEST",streaming:"yes",...v.recorder.display_name!=null&&{text:v.recorder.display_name}})}async function Dt({rtmpStreamKey:e}){if(e==null||e==="")return{success:!0,data:void 0};const t="/recapi/v0/rtmp/stop-recording",n=new URL(t,v.recorder.url);return await F(n,{rtmpStreamKey:e},{method:"POST"})}async function Nt({rtmpStreamKey:e}){const t=`/recapi/v0/rtmp/recording-status/${e}`,n=new URL(t,v.recorder.url),a=await F(n);return a.success&&Array.isArray(a.data)&&(a.data=a.data[0]),a}const{hostname:Ft}=new URL(v.recorder.url),Lt=({uri:e})=>{if(!/^rtmps?:\/\//.test(e))return!1;const{rtmpUrl:t}=L()??{};return t!=null&&e===t?!0:new URL(e.replace(/^rtmp/,"http")).hostname===Ft},Bt={startRecording:Wt,stopRecording:Dt,getStatus:Nt,isRecordingParticipant:Lt};async function Vt(e,t=60){const n="/api/v2/vc/start-recording",a=new URL(n,v.vbrick.url),o=v.infinity.sip_domain,i=`${Y.conferenceAlias}@${o}`;return await F(a,{title:e,sipAddress:i,sipPin:""},{method:"POST",timeoutSeconds:t})}async function Jt({videoId:e}){const t="/api/v2/vc/stop-recording",n=new URL(t,v.vbrick.url);return await F(n,{videoId:e},{method:"POST"})}async function Ht({videoId:e}){const t=`/api/v2/vc/recording-status/${e}`,n=new URL(t,v.vbrick.url),a=await F(n);return a.success?{success:!0,data:{videoId:e,status:a.data}}:a}const zt=e=>{const{hostname:t}=new URL(v.vbrick.url),n=`sip:${S.getUser()?.username}@${t}`;return e.uri===n},Gt={startRecording:Vt,stopRecording:Jt,getStatus:Ht,isRecordingParticipant:zt},W=v.recording_type==="rtmp"?Bt:Gt,qt=()=>{const e=[E.events.participantJoined.add(async({participant:t})=>{W.isRecordingParticipant(t)&&(Q()&&ne(t),Ce(!0),await wt(t.uuid))}),E.events.participantLeft.add(({participant:t})=>{W.isRecordingParticipant(t)&&(ne(t,!0),Ce(!1))}),E.events.participants.add(({participants:t})=>{Tt(t),Q()&&ne()})];E.events.me.addOnce(({participant:t})=>{t.role==="chair"?Xt():e.forEach(n=>{n()})})};function ne(e,t=!1){const n=L();if(e??=le(),n==null||e==null||n.participantUuid!=null&&e.uuid!==n.participantUuid)return;const a=Ut(e,t);n.status!==a&&(X({status:a,participantUuid:e.uuid}),M.emit("changed"))}async function Xt(){if(!(!ue()||de())){try{await Mt(15).catch(a=>{console.warn("Timeout waiting for participant list on first join",a)});const e=L(),t=le(),n=t!=null&&e?.participantUuid===t.uuid;if(xt()&&n)return}catch(e){console.error("Failed to refresh recording status",e)}Fe(),M.emit("changed")}}const Qt=async()=>{if(de()){await E.ui.showToast({message:"Another user has already enabled the recording"});return}const e=v.infinity.sip_domain,t=`${Y.conferenceAlias}@${e}`,n=await W.startRecording(t);n.success?(Ne({status:"Connecting",...n.data}),M.emit("changed"),await E.ui.showToast({message:"Recording requested. It will start in a few seconds."}),Kt()):await E.ui.showToast({message:"Cannot start the recording"})},Yt=async()=>{const e=L();(e!=null?await W.stopRecording(e):void 0)?.success===!0||!de()?(Fe(),M.emit("changed"),await E.ui.showToast({message:"Recording stopped"})):await E.ui.showToast({message:"Cannot stop the recording"})},Zt=async()=>{const e=L();if(e==null)return;const t=await W.getStatus(e);if(t.success){const{data:{status:n,videoId:a=e.videoId}}=t;return(n!==e.status||a!==e.videoId)&&(X({status:n,videoId:a}),M.emit("changed")),e.status}};async function Kt(e=60){const t=new Promise((n,a)=>M.once("changed",n));try{await ce(t,e)}catch{if(!Q())return;const a=le();a!=null&&a.serviceType!=="connecting"?(X({status:"Recording",participantUuid:a.uuid}),M.emit("changed")):(X({status:"ConnectingFailed"}),M.emit("changed"),await E.ui.showToast({message:"Cannot start the recording"}))}}const le=()=>{const{participantUuid:e}=L()??{};return De(e==null?W.isRecordingParticipant:t=>t.uuid===e)},de=()=>De(W.isRecordingParticipant)!=null,M=new Ae,D={init:qt,startRecording:Qt,stopRecording:Yt,getStatus:Zt,hasRecording:Le,isRecording:ue,emitter:M},en=async()=>{const e="Log out",t=await E.ui.addPrompt({title:"Log out",description:"Do you want to log out from Vbrick?",prompt:{primaryAction:e,secondaryAction:"Cancel"}});t.onInput.add(async n=>{await t.remove(),n===e&&await S.logout()})},Be={position:"toolbar",icon:"IconLiveStream",tooltip:"Recordings",roles:["chair"]};let oe;const Ve="pexip-vbrick-auth",Je="pexip-vbrick-videos",Ie="toolbar=0,scrollbars=1,status=1,resizable=1,location=1,menuBar=0,width=500,height=500,left=600,top=250",tn=async()=>{oe=await E.ui.addButton(Be),oe.onClick.add(rn)},H=async()=>{await oe.update({...Be,isActive:D.isRecording(),group:await nn()})},nn=async()=>{const e=await S.getAuthUrl();if(!S.isAuthenticated())return[{id:"login-button",icon:"IconLeave",tooltip:"Log in",roles:["chair"],opensPopup:{id:Ve,openParams:[e,"",Ie]}}];const t=[];return t.push(D.isRecording()?{id:"stop-button",icon:"IconStopRound",tooltip:"Stop recording",roles:["chair"],isActive:!0}:{id:"start-button",icon:"IconPlayRound",tooltip:"Start recording",roles:["chair"]},{id:"videos-button",icon:"IconOpenInNew",tooltip:"Manage recordings",roles:["chair"],opensPopup:{id:Je,openParams:[v.vbrick.url+"/#/media/uploads?sortField=whenUploaded","",Ie]}},{id:"logout-button",icon:"IconLeave",tooltip:"Log out",roles:["chair"]}),t},rn=({buttonId:e})=>{switch(e){case"login-button":{Se(Ve);break}case"logout-button":{en().catch(console.error);break}case"start-button":{D.startRecording().catch(console.error);break}case"stop-button":{D.stopRecording().catch(console.error);break}case"videos-button":{Se(Je);break}}},Se=e=>{setTimeout(()=>{window.plugin.popupManager.get(e)?.focus()},0)},ee=await dt({id:"plugin-recording-vbrick",version:0});ht(ee);D.init();await tn();ee.events.authenticatedWithConference.add(e=>{mt(e.conferenceAlias,e.conferenceName)});S.emitter.on("login",()=>{H().catch(console.error),ee.ui.showToast({message:"Logged into Vbrick"}).catch(console.error)});S.emitter.on("refreshed_token",()=>{H().catch(console.error)});S.emitter.on("logout",()=>{H().catch(console.error),ee.ui.showToast({message:"Logged out from Vbrick"}).catch(console.error)});D.emitter.on("changed",()=>{H().catch(console.error)});await S.isSessionValid()?await S.refreshAccessToken():(S.cleanSession(),await H());</script>

<body>
</body>

</html>